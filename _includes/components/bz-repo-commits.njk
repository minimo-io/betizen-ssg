{# _includes/components/bz-repo-commits.njk #}
<div id="repo-commits" class="w-full">
  <div class="flex items-center justify-between mb-6">
    <h3 class="text-2xl font-bold">Latest Commits</h3>
    <a href="https://github.com/minimo-io/betizen-ssg/commits" 
       target="_blank" 
       rel="noopener noreferrer"
       class="btn btn-sm btn-ghost gap-2">
      View on GitHub
      <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
        <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
      </svg>
    </a>
  </div>
  
  <div id="commits-loading" class="flex justify-center py-8">
    <span class="loading loading-spinner loading-lg text-primary"></span>
  </div>
  
  <div id="commits-error" class="alert alert-error hidden shadow-lg">
    <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>
    <span id="error-message">Failed to load commits</span>
  </div>
  
  <div id="commits-list" class="w-full space-y-4"></div>
</div>

<script>
(function() {
  const REPO_OWNER = 'minimo-io';
  const REPO_NAME = 'betizen-ssg';
  const API_URL = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/commits`;
  
  async function fetchCommits() {
    const loading = document.getElementById('commits-loading');
    const error = document.getElementById('commits-error');
    const list = document.getElementById('commits-list');
    
    try {
      const response = await fetch(`${API_URL}?per_page=10`);
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const commits = await response.json();
      
      loading.classList.add('hidden');
      
      if (commits.length === 0) {
        list.innerHTML = '<p class="text-center text-base-content/60">No commits found</p>';
        return;
      }
      
      list.innerHTML = commits.map(commit => {
        const date = new Date(commit.commit.author.date);
        const formattedDate = date.toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'short',
          day: 'numeric'
        });
        
        const message = commit.commit.message.split('\n')[0];
        const truncatedMessage = message.length > 100 
          ? message.substring(0, 100) + '...' 
          : message;
        
        // Try to get avatar from commit.author first, fallback to commit.committer
        const avatarUrl = commit.author?.avatar_url || commit.committer?.avatar_url || '';
        const authorName = commit.commit.author.name;
        const commitUrl = commit.html_url;
        const sha = commit.sha.substring(0, 7);
        
        return `
          <div class="card bg-base-100 shadow-lg hover:shadow-xl transition-shadow w-full">
            <div class="card-body p-6">
              <div class="flex items-center gap-4 w-full">
                ${avatarUrl ? `
                  <div class="avatar flex-shrink-0">
                    <div class="w-12 rounded-full">
                      <img src="${avatarUrl}" alt="${authorName}" />
                    </div>
                  </div>
                ` : `
                  <div class="avatar placeholder flex-shrink-0">
                    <div class="bg-neutral text-neutral-content rounded-full w-12">
                      <span class="text-xl">${authorName.charAt(0)}</span>
                    </div>
                  </div>
                `}
                
                <div class="flex-1 min-w-0">
                  <a href="${commitUrl}" 
                     target="_blank" 
                     rel="noopener noreferrer"
                     class="link link-hover font-medium text-base block mb-3">
                    ${truncatedMessage}
                  </a>
                  
                  <div class="flex flex-wrap items-center gap-2">
                    <div class="badge badge-neutral">${authorName}</div>
                    <div class="badge badge-outline">
                      <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M10.5 7.75a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0zm1.43.75a4.002 4.002 0 01-7.86 0H.75a.75.75 0 110-1.5h3.32a4.001 4.001 0 017.86 0h3.32a.75.75 0 110 1.5h-3.32z"/>
                      </svg>
                      ${sha}
                    </div>
                    <div class="badge badge-ghost">
                      <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                      </svg>
                      ${formattedDate}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
      
    } catch (err) {
      loading.classList.add('hidden');
      error.classList.remove('hidden');
      document.getElementById('error-message').textContent = 
        `Failed to load commits: ${err.message}`;
      console.error('Error fetching commits:', err);
    }
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', fetchCommits);
  } else {
    fetchCommits();
  }
})();
</script>